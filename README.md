# money-distributor

프로젝트의 구현은 `프로젝트 설계_guide.md`를 기반으로 하였습니다. 
프로젝트의 고도화 전략은 '프로젝트 고도화 전략_guide.md'를 참고해주세요.

이 문서는 뿌리기, 받기, 조회 기능의 구현 과정에서 발생할 수 있는 문제점과 해결방법을 정리한 문서입니다.

## 1. 토큰 관련 이슈

### 1.1 뿌리기 토큰 유효성 검증
- Redis와 MySQL을 사용한 이중 검증 구조 구현
- Redis: 실시간 토큰 유효성 검증 및 TTL 관리
- MySQL: 토큰 히스토리 영구 보관
- 검증 절차:
  1. 토큰 형식 검증 (3자리 영문 대문자 + 숫자)
  2. Redis에서 토큰 상태 확인 (active/expired)
  3. MySQL에서 토큰 히스토리 확인 가능

### 1.2 뿌리기 토큰 만료 처리
- Redis TTL 기능을 활용한 자동 만료 처리
- 토큰 저장 시 만료 시간 설정 (7일)
- 만료 처리 방식:
  1. 개별 토큰: `token:{token}` 키에 TTL 설정
  2. 토큰 목록: `used_tokens` Set에 TTL 설정 (토큰 만료 + 1분)
- 만료된 토큰 접근 시도 시 자동으로 -2 반환

### 1.3 뿌리기 토큰 중복 방지
- Redis의 Set 자료구조를 활용한 중복 체크
- Redis Transaction을 사용한 atomic 연산 보장
- 중복 방지 절차:
  1. Redis pipeline으로 토큰 존재 여부 확인
  2. MySQL에서 히스토리 체크
  3. 중복 발견 시 새로운 토큰 생성 시도

### 1.4 뿌리기 토큰 조회 속도 개선을 위한 캐싱 전략
- Redis를 활용한 토큰 정보 캐싱
- 캐시 구조:
  1. `used_tokens`: 사용 중인 토큰 Set
  2. `token:{token}`: 토큰 상세 정보 Hash
     - created_at: 생성 시간
     - status: 토큰 상태
- 장점:
  1. 빠른 토큰 검증 (Redis 메모리 기반)
  2. 자동 만료 처리 (TTL)
  3. MySQL 부하 감소

### 1.5 토큰의 재사용
- 만료된 토큰 재사용 정책 구현
- 재사용 조건:
  1. Redis에서 토큰이 만료(-2)된 경우 재사용 가능
- 장점:
  1. 제한된 토큰 공간(36^3) 효율적 사용
  2. 중복 가능성 감소
  3. 실제 유효한 토큰만 보호

## 2. 받기 api에서 발생할 수 있는 동시성 처리를 위한 메시지 큐(Message Queue) 도입

### 2.1 아키텍처
- RabbitMQ를 메시지 브로커로 사용
- Celery를 통한 비동기 작업 처리
- 비관적 락(Pessimistic Lock)을 통한 데이터 정합성 보장

### 2.2 주요 기능
1. **돈 받기 요청 처리**
   - API 요청 → RabbitMQ 큐 적재 → Celery 워커가 순차 처리
   - 동시 요청에 대한 경쟁 상태(Race Condition) 방지
   - 작업 실패 시 자동 재시도 메커니즘

2. **데이터 정합성 보장**
   - 비관적 락을 통한 동시 접근 제어
   - 트랜잭션 단위의 작업 처리
   - 롤백 처리를 통한 데이터 일관성 유지

### 2.3 시스템 구성
```
[FastAPI Server] → [RabbitMQ] → [Celery Workers]
     ↓                              ↓
     └──────────→ [Database] ←──────┘
```

### 2.4 모니터링
- RabbitMQ 관리자 페이지(http://localhost:15672)에서 큐 상태 확인
- Celery 워커 로그를 통한 작업 처리 현황 모니터링
- 에러 발생 시 자동 알림 및 로깅



[미구현]
## 3. 돈 뿌리기 후 받지 않는 잔액 환불 처리

### 3.1 미수령 뿌리기 환불 처리
- 미수령 잔액 환불 처리 로직(배치 처리)
- 7일이 지나면 받기 버튼 비활성화(프런트) 및 예외처리

### 3.2 미수령 뿌리기 환불 처리 예외 케이스
- 뿌리기 요청 후 받기 버튼 비활성화 전에 받기 버튼 클릭 시 예외처리(프런트 코드 미적용시 대비)

### 3.3 미수령 뿌리기 환불 처리 이력관리
- 환불 처리 이력 관리 필요
- wallet 잔액 환불 처리 이력 관리 필요